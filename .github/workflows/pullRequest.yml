name: On Pull Requests

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches:
      - develop

jobs:
  build:
    runs-on: self-hosted
    env:
      ANDROID_HOME: /Users/miam/Library/Android/sdk
    #if: github.event.pull_request.draft == false && (startsWith(github.head_ref, 'feature') || startsWith(github.head_ref, 'fix') || startsWith(github.head_ref, 'hotfix'))
    steps:
      - uses: actions/checkout@v3

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Run Android Lint
        run: ./gradlew lint

      - name: Verify iOS props
        run: |
          git fetch origin $GITHUB_BASE_REF:$GITHUB_BASE_REF

          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only $GITHUB_BASE_REF $GITHUB_SHA)

          # Check if PlausibleProps is changed and SharedAnalytics.ios is not
          if echo "$CHANGED_FILES" | grep -q 'mealz-shared-analytics/src/commonMain/kotlin/mealz/ai/PlausibleProps.kt' && ! echo "$CHANGED_FILES" | grep -q 'mealz-shared-analytics/src/iosMain/kotlin/mealz/ai/SharedAnalytics.ios.kt'; then
            echo "Error: PlausibleProps was changed but SharedAnalytics.ios was not updated!"
            exit 1
          fi

      - name: Test with Gradle
        run: ./gradlew alltest

      - name: Build iOS Gradle
        run: ./gradlew assembleXCFramework

      - name: Build Android Gradle
        run: ./gradlew assembleRelease

      - name: Build JS Gradle
        run: ./gradlew jsBrowserProductionWebpack

      - name: Check JS file size
        run: |
          cd mealz-shared-analytics/build/kotlin-webpack/js/productionExecutable
          export jsFileSize=$(du -k main.js | sed 's/[^0-9]//g')
          test $jsFileSize -lt 50
